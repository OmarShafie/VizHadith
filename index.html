<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
      var hadithURL = "https://raw.githubusercontent.com/OmarShafie/VizHadith/master/all_hadiths_clean.csv";
      var narratorsURL = "https://raw.githubusercontent.com/OmarShafie/VizHadith/master/all_rawis.csv";

      var inputType = "remote";
      var stepped = 0, rowCount = 0, errorCount = 0, firstError;
      var start, end;
      var firstRun = true;
      var maxUnparseLength = 10000;

      $(function()
      {
        // Demo invoked
        $('#submit').click(function()
        {
          if ($(this).prop('disabled') == "true")
            return;

          stepped = 0;
          rowCount = 0;
          errorCount = 0;
          firstError = undefined;

          var config = buildConfig();

          // Allow only one parse at a time
          $(this).prop('disabled', true);

          if (!firstRun)
            console.log("--------------------------------------------------");
          else
            firstRun = false;

          if (inputType == "local")
          {
            if (!$('#files')[0].files.length)
            {
              alert("Please choose at least one file to parse.");
              return enableButton();
            }

            $('#files').parse({
              config: config,
              before: function(file, inputElem)
              {
                start = now();
                console.log("Parsing file...", file);
              },
              error: function(err, file)
              {
                console.log("ERROR:", err, file);
                firstError = firstError || err;
                errorCount++;
              },
              complete: function()
              {
                end = now();
                printStats("Done with all files");
              }
            });
          }
          else if (inputType == "json")
          {
            if (!input)
            {
              alert("Please enter a valid JSON string to convert to CSV.");
              return enableButton();
            }

            start = now();
            var csv = Papa.unparse(input, config);
            end = now();

            console.log("Unparse complete");
            console.log("Time:", (end-start || "(Unknown; your browser does not support the Performance API)"), "ms");

            if (csv.length > maxUnparseLength)
            {
              csv = csv.substr(0, maxUnparseLength);
              console.log("(Results truncated for brevity)");
            }

            console.log(csv);

            setTimeout(enableButton, 100);	// hackity-hack
          }

          else
          {
            start = now();
            var narratorsData;
        Papa.parse(narratorsURL,  {
          delimiter: $('#delimiter').val(),
          header: $('#header').prop('checked'),
          dynamicTyping: $('#dynamicTyping').prop('checked'),
          skipEmptyLines: $('#skipEmptyLines').prop('checked'),
          preview: parseInt($('#preview').val() || 0),
          step: $('#stream').prop('checked') ? stepFn : undefined,
          encoding: $('#encoding').val(),
          worker: $('#worker').prop('checked'),
          comments: $('#comments').val(),
          complete: saveNarrators,
          error: errorFn,
          download: inputType == "remote"
        });
            if (config.worker || config.download)
              console.log("Running...");
          }
        });

        $('#insert-tab').click(function()
        {
          $('#delimiter').val('\t');
        });
      });

      function printStats(msg)
      {
        if (msg)
          console.log(msg);
        console.log("       Time:", (end-start || "(Unknown; your browser does not support the Performance API)"), "ms");
        console.log("  Row count:", rowCount);
        if (stepped)
          console.log("    Stepped:", stepped);
        console.log("     Errors:", errorCount);
        if (errorCount)
          console.log("First error:", firstError);
      }



      function buildConfig()
      {
        return {
          delimiter: $('#delimiter').val(),
          header: $('#header').prop('checked'),
          dynamicTyping: $('#dynamicTyping').prop('checked'),
          skipEmptyLines: $('#skipEmptyLines').prop('checked'),
          preview: parseInt($('#preview').val() || 0),
          step: $('#stream').prop('checked') ? stepFn : undefined,
          encoding: $('#encoding').val(),
          worker: $('#worker').prop('checked'),
          comments: $('#comments').val(),
          complete: completeFn,
          error: errorFn,
          download: inputType == "remote"
        };
      }

      function stepFn(results, parser)
      {
        stepped++;
        if (results)
        {
          if (results.data)
            rowCount += results.data.length;
          if (results.errors)
          {
            errorCount += results.errors.length;
            firstError = firstError || results.errors[0];
          }
        }
      }


      function saveNarrators(results)
      {

        console.log("Parsed Narrators...");
        end = now();

        if (results && results.errors)
        {
          if (results.errors)
          {
            errorCount = results.errors.length;
            firstError = results.errors[0];
          }
          if (results.data && results.data.length > 0)
            rowCount = results.data.length;
        }
        narratorsData = results.data;
        Papa.parse(hadithURL, buildConfig());

        // icky hack
        setTimeout(enableButton, 100);
      }

      function completeFn(results)
      { 
        console.log("Parsed Hadiths...");
        end = now();

        if (results && results.errors)
        {
          if (results.errors)
          {
            errorCount = results.errors.length;
            firstError = results.errors[0];
          }
          if (results.data && results.data.length > 0)
            rowCount = results.data.length;
        }

        process(results.data, narratorsData);
        //printStats("Parse complete");

        // icky hack
        setTimeout(enableButton, 100);
      }

      function errorFn(err, file)
      {
        end = now();
        console.log("ERROR:", err, file);
        enableButton();
      }

      function enableButton()
      {
        $('#submit').prop('disabled', false);
      }

      function now()
      {
        return typeof window.performance !== 'undefined'
            ? window.performance.now()
            : 0;
      }

      function lookupNarrator(index){
        return narratorsData.find(function(element) {
        return element[0] == index;
      });
      }
      function process(hadithData, narratorsData){

        console.log("Start Processing...");
        var row =0;
        var hadith=0;
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Weight');

        for(var i = 1; i < hadithData.length;i++)
        {
          hadith++;
          row =0;
          if(hadithData[i][6].includes("11013")){ // Al zuhry
             var chain = hadithData[i][6].split(", ");
             for(var n = 0; n < chain.length -1;n++)
             {
               var narrator = lookupNarrator(chain[n]);
               if(narrator) {
                  var teachers = narrator[10];
                  if (teachers.includes(chain[n+1])) {
                    data.addRow([lookupNarrator(chain[n])[1].slice(0,20), lookupNarrator(chain[n+1])[1].slice(0,20),1]);
                 row++;
                  }
                 else{
                  console.log("narrator is missing", chain[n]);
                 }
               }
          }
        }
      }
      google.charts.setOnLoadCallback(drawChart(data));
      }
    </script>
    <script type="text/javascript">
      google.charts.load('current', {'packages':['sankey']});
      function drawChart(data) {
        /*var data = new google.visualization.DataTable();
        data.addColumn('string', 'From');
        data.addColumn('string', 'To');
        data.addColumn('number', 'Weight');
        data.addRows([
          [ 'سالم بن عبد الله بن عمر', 'عبد الله بن عمر', 2946],
          [ 'عبيد الله بن عبد الله بن عتبة', 'ابن عباس', 1093],
          [ 'سعيد بن المسيب', 'أبو هريرة', 2009],
          [ 'الأعرج', 'أبو هريرة', 1948],
          [ 'أبو سلمة بن عبد الرحمن بن عوف', 'أبو هريرة', 3649],
          [ 'أبو سلمة بن عبد الرحمن بن عوف', 'عائشة', 877],
          [ 'عمرة بنت عبد الرحمن', 'عائشة', 1000],
          [ 'عروة بن الزبير', 'عائشة', 5815],
          
          [ 'الزهري', 'أنس بن مالك', 961],
          [ 'الزهري', 'سعيد بن المسيب', 2563],
          [ 'الزهري', 'أبو سلمة بن عبد الرحمن بن عوف', 2020],
          [ 'الزهري', 'الأعرج', 177],
          [ 'الزهري', 'سالم بن عبد الله بن عمر', 2103],
          [ 'الزهري', 'عبد الله بن عمر', 53],
          [ 'الزهري', 'عروة بن الزبير', 2990],
          [ 'الزهري', 'عمرة بنت عبد الرحمن', 183],
          [ 'الزهري', 'عبيد الله بن عبد الله بن عتبة', 1693],
          
          [ 'مالك بن أنس', 'الزهري', 1792],
          [ 'سفيان بن عيينة', 'الزهري', 2368],
          [ 'معمر بن راشد الأزدي', 'الزهري', 4758],
          [ 'عقيل بن خالد', 'الزهري', 1026],
          [ 'يونس بن يزيد الأيلي', 'الزهري', 2480],
          [ 'شعيب بن أبي حمزة', 'الزهري', 801],
          
          [ 'قتيبة بن سعيد', 'مالك بن أنس', 573],
          [ 'قتيبة بن سعيد', 'سفيان بن عيينة', 400],
          [ 'قتيبة بن سعيد', 'الليث بن سعد', 1168],
          
          [ 'زهير بن حرب', 'سفيان بن عيينة', 418],
          
          [ 'أحمد بن حنبل', 'سفيان بن عيينة', 839],
          [ 'أحمد بن حنبل', 'عبد الرزاق الصنعاني', 1870],
          
          [ 'عبد الرزاق الصنعاني', 'معمر بن راشد الأزدي', 10848],
          [ 'عبد الله بن المبارك', 'معمر بن راشد الأزدي', 493],
          
          [ 'عبد الله بن المبارك', 'يونس بن يزيد الأيلي', 363],
          [ 'عبد الله بن وهب', 'يونس بن يزيد الأيلي', 1452],
          
          [ 'الليث بن سعد', 'يونس بن يزيد الأيلي', 158],
          [ 'الليث بن سعد', 'عقيل بن خالد', 724],
          
          [ 'الحكم بن نافع', 'شعيب بن أبي حمزة', 774],
          
          [ 'إسحاق بن راهويه', 'عبد الرزاق الصنعاني', 1],
          [ 'الحسن بن علي الخلال', 'عبد الرزاق الصنعاني', 1],
          
          [ 'أبو كريب محمد بن العلاء', 'عبد الله بن المبارك', 54],
          
          [ 'أبو الطاهر بن السرح', 'عبد الله بن وهب', 	602],
          [ 'هارون بن سعيد الأيلي', 'عبد الله بن وهب', 	170],
          [ 'حرملة بن يحيى النجيبي', 'عبد الله بن وهب', 866],
          
          [ 'البخاري', 'قتيبة بن سعيد', 325],
          [ 'مسلم', 'قتيبة بن سعيد', 689],
          [ 'أبو داود', 'قتيبة بن سعيد', 266],
          [ 'النسائي', 'قتيبة بن سعيد', 1938],
          [ 'الترمذي', 'قتيبة بن سعيد', 667],
          
          
          [ 'البخاري', 'زهير بن حرب', 12],
          [ 'مسلم', 'زهير بن حرب', 764],
          [ 'أبو داود', 'زهير بن حرب', 52],
          [ 'ابن ماجه', 'زهير بن حرب', 2],
          
          
          [ 'البخاري', 'أحمد بن حنبل', 2],
          [ 'مسلم', 'أحمد بن حنبل', 21],
          [ 'أبو داود', 'أحمد بن حنبل', 309],
          
          [ 'مسلم', 'الحسن بن علي الخلال', 	108],
          [ 'أبو داود', 'الحسن بن علي الخلال', 	178],
          [ 'الترمذي', 'الحسن بن علي الخلال', 95],
          [ 'ابن ماجه', 'الحسن بن علي الخلال', 	24],
          
          [ 'البخاري', 'أبو كريب محمد بن العلاء', 53],
          [ 'مسلم', 'أبو كريب محمد بن العلاء', 514],
          [ 'أبو داود', 'أبو كريب محمد بن العلاء', 133],
          [ 'النسائي', 'أبو كريب محمد بن العلاء', 128],
          [ 'الترمذي', 'أبو كريب محمد بن العلاء', 189],
          [ 'ابن ماجه', 'أبو كريب محمد بن العلاء', 104],
          
          [ 'مسلم', 'أبو الطاهر بن السرح', 237],
          [ 'أبو داود', 'أبو الطاهر بن السرح', 139],
          [ 'النسائي', 'أبو الطاهر بن السرح', 137],
          [ 'ابن ماجه', 'أبو الطاهر بن السرح', 26],
          
          [ 'مسلم', 'هارون بن سعيد الأيلي', 114],
          [ 'أبو داود', 'هارون بن سعيد الأيلي', 4],
          [ 'النسائي', 'هارون بن سعيد الأيلي', 16],
          [ 'ابن ماجه', 'هارون بن سعيد الأيلي', 6],
          
          [ 'مسلم', 'حرملة بن يحيى النجيبي', 271],
          [ 'ابن ماجه', 'حرملة بن يحيى النجيبي', 	50],
          
          [ 'البخاري', 'الحكم بن نافع', 	289],
          
        ]);*/
        // Sets chart options.
        var options = {
          width: 1200,
        };
        // Instantiates and draws our chart, passing in some options.
        var chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
        chart.draw(data, options);
      }
    </script>
  </head>
  <body>
    <div id="sankey_basic" style="width: 1000px; height: 600px;"></div>
    <div class="input-area" id="input-remote">

      <div class="text-center">
        Type the URL of the file to be downloaded and parsed.
        <br>
        <small>(cross-origin requests require Access-Control-Allow-Origin header)</small>
      </div>
    </div>
    <button id="submit" class="green">Parse</button>
  </body>
</html>
