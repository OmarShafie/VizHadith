<!DOCTYPE html>
<html lang="ar" >
  <head>
    <title>Viz Hadith</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" >
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel='dns-prefetch' href='//fonts.googleapis.com' />
  <link href="https://fonts.googleapis.com/css?family=Almarai:300,700|El+Messiri&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="hadithViz.js"></script>

    <link rel="stylesheet" type="text/css" href="main.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css">
		<link href="https://fonts.googleapis.com/css?family=El+Messiri|Tajawal&display=swap" rel="stylesheet">
  </head>
  
  <body id="screen">
  <nav id="sidebar" class="active">
		<ul class="list-unstyled components mb-5">
			<li class="active fab icon">
				<a onclick="openNav()">
					<span class="fa fa-bars"></span>
				</a>
			</li>
			<li class="active">
				<a onclick="openSearch()"><span class="fa fa-search"></span>Search</a>
			</li>
			<li class="active">
				<a onclick="openSearch()"><span class="fa fa-sliders-h"></span>Settings</a>
			</li>
			<li class="active">
				<a onclick="openSearch()"><span class="fa fa-info-circle"></span>About</a>
			</li>
		</ul>

		<div id="mySidenav" class="sidenav bg-dark text-center">
			<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
			<ul style="align-items: center;">
				<li class="active">
					<a onclick="openSearch()"><span class="fa fa-search"></span>Search</a>
				</li>
				<li class="active">
					<a onclick="openSearch()"><span class="fa fa-sliders-h"></span>Settings</a>
				</li>
				<li class="active">
					<a onclick="openSearch()"><span class="fa fa-info-circle"></span>About</a>
				</li>
			</ul>
		</div>
	</nav>
	<div id="mySidesearch" class="sidesearch bg-dark text-center">
	<h2>Search Form</h2>
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
		<div class="row justify-content-center form-inline">
			<label for="input">Hadith contains:</label>
			<input type="text" class="form-control " id="input" dir="rtl" required placeholder="الأعمال بالنية">
		</div><br>
		<div class="row justify-content-center form-inline">
			<label for="numNarrators">Max Narrators: </label>
			<input type="number" class="form-control" id="numNarrators" placeholder=50>
		</div><br>

		<div class="row justify-content-center">
			  <input type="checkbox" id="0" value=1 checked> Bukhari <br>
			  <input type="checkbox" id="1" value=1 disabled> Muslim <br>
		</div><br>
		<div class="row justify-content-center">
			  <input type="checkbox" id="2" value=1 disabled> Abu Daw'ud  <br>
			<input type="checkbox" id="3" value=1 disabled> Al Termithi <br>
		</div><br>
		<div class="row justify-content-center">
			  <input type="checkbox" id="4" value=1 disabled> Nasa'i <br>
			<input type="checkbox" id="5" value=1 disabled> Ibn Majah <br>
		</div><br>
		<div class="row justify-content-center">  Color Sankey:
			<label class="switch">
				<input id="colorLinksSwitch" type="checkbox" checked>
				<span class="switchSlider round"></span>
			</label>
		  </div> <br>
		<div class="row justify-content-center form-inline">
		   <div class="col form-inline slidecontainer">
			<p>Nodes Spread: <span id="demo"></span>
			<input type="range" min="1" max="5" value="3" class="slider" id="myRange">
		  </div>
		</div>
		
		<div class="row justify-content-center mx-3 form-inline">
		  <div>
			<button type="button" id="submit" class="btn btn-primary"> Submit</button>
			<button type="button" id="rotate" class="btn btn-primary" disabled><i class="fa fa-sync-alt"></i></button>
		  </div>
		</div>
		<div class="row justify-content-center">
			<label id="btnMessage"></label>
		</div>
		</div>
  <div class="container-fluid" id="form">
	  <div id="header">
		<br>
		<br>
		<h1 class="text-center">Hadith Visualizer</h1>
		<h2 class="text-center small">Visual Analysis of hadith narration chains.</h2>

		</div>
		 <div class='row justify-content-center my-legend'>
		  <div class='legend-title'><!--Narrator Grade Legend:--></div>
			<div class='legend-scale'>
			  <ul class='legend-labels'>
				<li><span style='background:darkgreen;'></span>صحابي</li>
				<li><span style='background:seagreen;'></span>ثقة ثقة</li>
				<li><span style='background:mediumseagreen;'></span>مخضرم</li>
				<li><span style='background:springgreen;'></span>ثقة</li>
				<li><span style='background:greenyellow;'></span>صدوق</li>
				<li><span style='background:yellow;'></span>مقبول</li>
				<li><span style='background:gold;'></span>تغير \ اختلط</li>
				<li><span style='background:coral;'></span>مدلس</li>
				<li><span style='background:lightcoral;'></span>لين</li>
				<li><span style='background:red;'></span>ضعيف</li>
				<li><span style='background:crimson;'></span>منكر \ متروك</li>
				<li><span style='background:maroon;'></span>كذاب</li>
				<li><span style='background:silver;'></span>مجهول \ مستور</li>
				<li><span style='background:lightslategray;'></span>أخرى</li>
				<li><span style='background:darkslategray;'></span>No Data</li>
			  </ul>
			</div>
			<span class="tooltiptext" id="gradeTooltip">Tooltip text</span>
		  </div>
      <div class="row justify-content-between">
        <div id="sankey_basic" class='horizontal-sankey' style="margin-bottom:-100px; margin-left:100px;"></div>
      </div>
    </div>
    <script>
		function openSearch() {
			  document.getElementById("mySidesearch").style.width = "320px";
		}
		function closeNav() {
		  document.getElementById("mySidenav").style.width = "0";
		  document.getElementById("mySidesearch").style.width = "0";
		}
		function openNav() {
			  document.getElementById("mySidenav").style.width = "320px";
		}
	var isVertical = false;//vertical
	
	var sankey_height = 0;
	var sankey_w = 0
		var inputFeild = document.getElementById("form");
		inputFeild.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
		   event.preventDefault();
		   document.getElementById("submit").click();
		  }
		});
      google.charts.load('current', {'packages':['sankey']});
      var slider = document.getElementById("myRange");
      var output = document.getElementById("demo");
      output.innerHTML = slider.value;
      slider.oninput = function() {
        output.innerHTML = this.value;
      }

	  var selection_array = [];
	  var clickDisabled = true;

	  function colorLinksbyNarration(){
	  	if (document.getElementById("colorLinksSwitch").checked){
	  		return true;
	  	}
	  	return false;
	  }
      function drawChart(data) {
        
        // Sets chart options.
		//var screen_h = Math.min(screen.width,screen.height - 170);
		var node_height = Math.min(100,20*(first_layer_total/first_layer_count));
		var padding = 15*parseInt(slider.value);
		var layer_height = 100;
		sankey_height = first_layer_count*node_height + (first_layer_count-1)*padding;
		sankey_w = isVertical? longest_sanad*layer_height + 200*(parseInt(slider.value)/5): Math.max(longest_sanad*210,Math.max(screen.width,screen.height)-100);
        document.querySelector("#screen").style.setProperty("width",sankey_w+100+"px");
        var options = {
          width: sankey_w,
          height: isVertical? Math.max(screen.width,screen.height)-20 : sankey_height,
          tooltip: {isHtml: true},
          sankey: {
            allowHtml: true,
            tooltip: { isHtml: true,},
            iterations: 64,
            link: { color: { fill: "lightslategray", fillOpacity: 0.5 } },
            node: {
              interactivity:true,
              nodePadding: padding,
			  labelPadding: 5,
			  width: 10,
              label: {
                fontName: 'Almarai',
                fontSize: 12,
                italic: true,
              }
            },
          }
        };
		
        var chartDiv = document.getElementById('sankey_basic');
        var chart = new google.visualization.Sankey(chartDiv);
        
		  var colorNodes = {};
		  var textIndex = 0;
		  var rectIndex = 0;

        var observer = new MutationObserver(function (mutations) {

		  	var pathIndex = 0;
          mutations.forEach(function (mutation) {
            mutation.addedNodes.forEach(function (node) {
              if (node.tagName === 'text') {
                colorNodes[textIndex] = gradeToColor(getNarratorGrade(getNarratorFromName(node.innerHTML)));
                textIndex++;
              }
              if (node.tagName === 'rect') {
                node.setAttribute('fill', colorNodes[rectIndex]);
                rectIndex++;
              }
              if (node.tagName === 'path' && colorLinksbyNarration()) {
                node.setAttribute('fill', colorLinks[pathIndex]);
                node.setAttribute('opacity', 0.3);
                pathIndex++;
              }
            });
          });
        });
              
        observer.observe(chartDiv, {
          childList: true,
          subtree: true
        });

        google.visualization.events.addListener(chart, 'select', function() {
        var sel = chart.getSelection();
        if (sel.length) {
          console.log(sel);
		  //window.open('http://www.bing.com');
        }
      });
		
        google.visualization.events.addListener(chart, 'onmouseover', function(e) {
		if(e.name){
			var gradeTooltip = document.querySelector("#gradeTooltip");
			gradeTooltip.style.setProperty('visibility', "visible");
			gradeTooltip.innerHTML = lookupNarrator(getNarratorFromName(e.name))[1] + " : <span style = 'color :" + gradeToColor(getNarratorGrade(getNarratorFromName(e.name))) + ";'>" +getNarratorGrade(getNarratorFromName(e.name))+ "</span>";
		}
		if(!e.name){
			clickDisabled = false;
		}
      });
	  
	  google.visualization.events.addListener(chart, 'onmouseout', function(e) {
	  
		if (e.name){
		  var gradeTooltip = document.querySelector("#gradeTooltip");
		  gradeTooltip.style.setProperty('visibility', "hidden");
		}
		if(!e.name){
			clickDisabled = true;
		}
      });
        chart.draw(data, options);
		closeNav();
      }
	  
	  var xOffset = 300;
	  var yOffset = 250 + document.querySelector("#header").offsetHeight;
      const el = document.querySelector("#screen");//tooltip
      el.style.setProperty('--v', "none");
      el.addEventListener("click", (e) => {
  
		yOffset = sankey_height + 150 + document.querySelector("#header").offsetHeight;
        if (el.style.getPropertyValue('--v') != "block" && !clickDisabled){
          el.style.setProperty('--x', Math.min(sankey_w -2*xOffset,Math.max(0,e.pageX - xOffset)) + "px");
          el.style.setProperty('--y', Math.max(-sankey_height-150,Math.min(-200,e.pageY - yOffset))+ "px");
          el.style.setProperty('--v', "block");
        }
      }, true);

      el.addEventListener("mousemove", (e) => {
        var xPos = Math.max(e.pageX - parseInt(el.style.getPropertyValue('--x').split("px")[0]), parseInt(el.style.getPropertyValue('--x').split("px")[0]) -e.pageX);
        var yPos = 150 + e.pageY - yOffset - parseInt(el.style.getPropertyValue('--y').split("px")[0]);
		
        if (el.style.getPropertyValue('--v') == "block"){
          if (xPos> 590 || xPos < 10 || yPos > 290 || yPos < 10) {
            el.style.setProperty('--v', "none");
			clickDisabled = true;
          }
        }
      });
	  
    </script>
  </body>
<!--footer style="height: 50px; text-align: center;" class="justify-content-between">
	<i class="fa fa-copyright"></i> 2019 Omar Shafie in Doha, Qatar- All Rights Reserved - 
  </footer-->
</html>
