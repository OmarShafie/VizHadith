<html>
  <head>
    <title>Viz Hadith</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript">
      function getNarratorGrade(tag){
      var narrator_index = tag.split(" ")[0];
      var narrator = lookupNarrator(narrator_index);
      if (narrator.length === 25) {
        return narrator[12];
      }
      return "NA";
    }

    function gradeToColor(grade){
      var mapping = {
        1 : "darkgreen",
        2 : "seagreen",
        3 : "mediumseagreen",
        4 : "mediumseagreen",
        5 : "springgreen",
        6 : "lime",
        7 : "greenyellow",
        8 : "yellow",
        9 : "gold",
        10: "coral",
        11: "lightcoral",
        12: "lightcoral",
        13: "red",
        14: "crimson",
        15: "maroon",
        16: "silver",
        17: "lightslategray",
        18: "darkslategray",
      };
      if (grade.includes("صحابي") || grade.includes("صحابة") || grade.includes("صحبة")){
        return mapping[1];
      }
      else if (grade.includes("أوثق")){
        return mapping[2];
      }
      else if (grade.includes("Narrator[Grade:Thiqah Thiqah]") || grade.includes("ثبت")  || grade.includes("حافظ") || grade.includes("ثقة ثقة")){
        return mapping[3];
      }
      else if (grade.includes("Narrator[Grade:No Doubt]")  || grade.includes("البخاري")  || grade.includes("مسلم")){
        return mapping[4];
      }
      else if (grade.includes("Narrator[Grade:Thiqah]") || grade.includes("ثقة")){
        return mapping[5];
      }
      else if (grade.includes("Narrator[4") || grade.includes("الأربعة") || grade.includes("الستة")){
        return mapping[6];
      }
      else if (grade.includes("Narrator[Grade:Sadooq]") || grade.includes("صدوق")  ){
        return mapping[7];
      }
      else if (grade.includes("Narrator[Grade:Sadooq/Delusion]")){
        return mapping[8];
      }
      else if (grade.includes("Narrator[Grade:Maqbool]")  || grade.includes("مقبول")){
        return mapping[9];
      }
      else if (grade.includes("لين")){
        return mapping[10];
      }
      else if (grade.includes("Narrator[Grade:Not Thiqah]") || grade.includes("Narrator[Grade:Unknown-Majhool]") || grade.includes("مجهول") || grade.includes("مستور")){
        return mapping[11];
      }
      else if (grade.includes("Narrator[Grade:Undefined]")){
        return mapping[12];
      }
      else if (grade.includes("Narrator[Grade:Abandoned]") || grade.includes("متروك") || grade.includes("منكر")){
        return mapping[13];
      }
      else if (grade.includes("Narrator[Grade:Weak]") || grade.includes("ضعيف")){
        return mapping[14];
      }
      else if (grade.includes("Narrator[Grade:Liar]") || grade.includes("كذب")){
        return mapping[15];
      }
      else if (grade.includes("Narrator")){
        return mapping[16];
      }
      else if (grade.includes("NA")){
        return mapping[17];
      }
      else{
        return mapping[18];
      }
    }

      google.charts.load('current', {'packages':['sankey']});
      function drawChart(data) {
        
        // Sets chart options.
        var options = {
          width: 1366,
          height: 700,
          tooltip: {isHtml: true},
          sankey: {
            allowHtml: 'true',
            tooltip: {
                isHtml: 'true'
            },
            iterations: 100,
            link: { color: { fill: 'paleturquoise', fillOpacity: 0.6 } },
            node: {
              interactivity:true,
              //nodePadding: 50,
              label: {
                //fontName: 'Times-Roman',
                fontSize: 10,
                //italic: true,
              }
            },
          }
        };

        var chartDiv = document.getElementById('sankey_basic');
        var chart = new google.visualization.Sankey(chartDiv);
              
              var colorMap = {};
              var textIndex = 0;
              var rectIndex = 0;
              var pathIndex = 0;
        var observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            mutation.addedNodes.forEach(function (node) {
              if (node.tagName === 'text') {
                colorMap[textIndex] = gradeToColor(getNarratorGrade(node.innerHTML));
                textIndex++;
              }
              if (node.tagName === 'rect') {
                node.setAttribute('fill', colorMap[rectIndex]);
                rectIndex++;
              }
            });
          });
        });
              
        observer.observe(chartDiv, {
          childList: true,
          subtree: true
        });

        google.visualization.events.addListener(chart, 'select', function() {
        var sel = chart.getSelection();
        if (sel.length) {
          console.log(sel[0].name)
        }
      });

        chart.draw(data, options);
      }
    </script>
    <link rel="stylesheet" type="text/css" href="main.css">
  </head>
  <body>
    <h1 class="text-center">Hadith Visualizer</h1>
    <h2 class="text-center small">Visual Analysis of hadith narration chains.</h2>
    
  <div class="container">
    <div class="row justify-content-center mx-3 form-inline">
        <div class="col-3 align-self-end px-3">
        <label for="input">Hadith contains:</label>
        <input type="text" class="form-control " id="input" required placeholder="إنما الأعمال بالنيات">
      </div>
      <div class="col-2 px-3 align-self-end">
        <button type="button" id="submit" class="btn btn-primary"> Submit</button>
      </div>
      <div class=col 'my-legend'>
      <div class='legend-title'>Narrator Grade Legend:</div>
      <div class='legend-scale'>
        <ul class='legend-labels'>
          <li><span style='background:darkgreen;'></span>صحابي</li>
          <li><span style='background:seagreen;'></span>أوثق الناس</li>
          <li><span style='background:mediumseagreen;'></span>ثقة ثقة</li>
          <li><span style='background:lime;'></span>ثقة</li>
          <li><span style='background:greenyellow;'></span>صدوق</li>
          <li><span style='background:yellow;'></span>له أوهام</li>
          <li><span style='background:gold;'></span>مقبول</li>
          <li><span style='background:coral;'></span>لين</li>
          <li><span style='background:lightcoral;'></span>مجهول</li>
          <li><span style='background:red;'></span>ضعيف</li>
          <li><span style='background:crimson;'></span>منكر\ متروك</li>
          <li><span style='background:maroon;'></span>كذاب</li>
          <li><span style='background:silver;'></span>Narrator</li>
          <li><span style='background:lightslategray;'></span>NA</li>
          <li><span style='background:darkslategray;'></span>No Data</li>
        </ul>
      </div>
    </div>
    </div>
  <div class="row justify-content-center">
      <label id="btnMessage"></label>
  </div>
   
      <div class="row justify-content-center">
        <div id="sankey_basic"></div>
      </div>
    </div> 
    <script src="hadithViz.js"></script>
    <script type="text/javascript">
      const el = document.querySelector("#sankey_basic");
      el.addEventListener("click", (e) => {
        el.style.setProperty('--x', e.offsetX -300 + "px");
        el.style.setProperty('--y', e.offsetY -150 + "px");
        el.style.setProperty('--v', "visible");
      }, true);

      el.addEventListener("mousemove", (e) => {
        if (e.offsetX > 600 || e.offsetX < 10 || e.offsetY > 250 || e.offsetY < -100) {
          el.style.setProperty('--v', "hidden");
        }
      });
    </script>
  </body>
</html>
