<!DOCTYPE html>
<html lang="ar">
  <head>
    <title>Viz Hadith</title>
  <meta name="viewport" content="width=device-width, initial-scale=1 " >
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel='dns-prefetch' href='//fonts.googleapis.com' />
  <link href="https://fonts.googleapis.com/css?family=Almarai:300,700|El+Messiri&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="hadithViz.js"></script>

    <link rel="stylesheet" type="text/css" href="main.css">
  </head>
  <body>
  <div class="container" id="form">
    <br>
    <h1 class="text-center">Hadith Visualizer</h1>
    <h2 class="text-center small">Visual Analysis of hadith narration chains.</h2>
    
    <div class="row justify-content-center mx-3 form-inline">
      
      <div class="col-6 form-inline px-3">
        <label for="numNarrators">Max Narrators: </label>
        <input type="number" class="form-control" id="numNarrators" placeholder=50>
      </div>
      <div class="col-4 form-inline slidecontainer">
        <input type="range" min="1" max="5" value="3" class="slider" id="myRange">
        <p>Spread: <span id="demo"></span></p>
      </div>

    </div>

    <div class="row justify-content-center mx-3 form-inline">
      
      
      <div class="col-6 form-inline px-3">
        <label for="input">Hadith contains:</label>
        <input type="text" class="form-control " id="input" required placeholder="الأعمال بالنية">
      </div>
      <div class="col-2">
          <input type="checkbox" id="0" value=1 checked> Bukhari <br>
          <input type="checkbox" id="2" value=1 disabled> Abu Daw'ud  <br>
          <input type="checkbox" id="4" value=1 disabled> Nasa'i <br>
      </div>
      <div class="col-2">
        <input type="checkbox" id="1" value=1 disabled> Muslim <br>
        <input type="checkbox" id="3" value=1 disabled> Al Termithi <br>
        <input type="checkbox" id="5" value=1 disabled> Ibn Majah <br>
      </div>
    </div>
    
    <div class="row justify-content-center mx-3 form-inline">
      <div>
        <button type="button" id="submit" class="btn btn-primary"> Submit</button>
      </div>
    </div>
    <div class="row justify-content-center">
        <label id="btnMessage"></label>
    </div>
     <div class='row justify-content-center my-legend' style="position: sticky; top: 0; z-index: 1000;">
      <div class='legend-title'><!--Narrator Grade Legend:--></div>
        <div class='legend-scale'>
          <ul class='legend-labels'>
            <li><span style='background:darkgreen;'></span>صحابي</li>
            <li><span style='background:seagreen;'></span>ثقة ثقة</li>
            <li><span style='background:mediumseagreen;'></span>مخضرم</li>
            <li><span style='background:springgreen;'></span>ثقة</li>
            <li><span style='background:greenyellow;'></span>صدوق</li>
            <li><span style='background:yellow;'></span>مقبول</li>
            <li><span style='background:gold;'></span>تغير \ اختلط</li>
            <li><span style='background:coral;'></span>مدلس</li>
            <li><span style='background:lightcoral;'></span>لين</li>
            <li><span style='background:red;'></span>ضعيف</li>
            <li><span style='background:crimson;'></span>منكر \ متروك</li>
            <li><span style='background:maroon;'></span>كذاب</li>
            <li><span style='background:silver;'></span>مجهول \ مستور</li>
            <li><span style='background:lightslategray;'></span>أخرى</li>
            <li><span style='background:darkslategray;'></span>No Data</li>
          </ul>
        </div>
		<span class="tooltiptext" id="gradeTooltip">Tooltip text</span>
	  </div>
      <div class="row justify-content-center">
        <div id="sankey_basic" style="margin-bottom: 100px;"></div>
      </div>
    </div>
    <script>
		var inputFeild = document.getElementById("form");
		inputFeild.addEventListener("keyup", function(event) {
		  if (event.keyCode === 13) {
		   event.preventDefault();
		   document.getElementById("submit").click();
		  }
		});
      google.charts.load('current', {'packages':['sankey']});
      var slider = document.getElementById("myRange");
      var output = document.getElementById("demo");
      output.innerHTML = slider.value;
      slider.oninput = function() {
        output.innerHTML = this.value;
      }

	  var selection_array = [];
	  var clickDisabled = true;
      function drawChart(data,first_layer_count, first_layer_total) {
        
        // Sets chart options.
		var screen_h = Math.min(screen.width,screen.height - 170);
		var node_height = Math.min(100,20*(first_layer_total/first_layer_count));
		var padding = 15*parseInt(slider.value);
        var options = {
          width: 1900,//Math.max(screen.width,screen.height) - 20,
          height: first_layer_count*node_height + (first_layer_count-1)*padding,
          tooltip: {isHtml: true},
          sankey: {
            allowHtml: true,
            tooltip: { isHtml: true,},
            iterations: 64,
            link: { color: { fill: "lightslategray", fillOpacity: 0.5 } },
            node: {
              interactivity:true,
              nodePadding: padding,
			  labelPadding: 5,
			  width: 10,
              label: {
                fontName: 'Almarai',
                fontSize: 12,
                italic: true,
              }
            },
          }
        };

        var chartDiv = document.getElementById('sankey_basic');
        var chart = new google.visualization.Sankey(chartDiv);
        
		  var colorMap = {};
		  var textIndex = 0;
		  var rectIndex = 0;
		  var pathIndex = 0;
        var observer = new MutationObserver(function (mutations) {
          mutations.forEach(function (mutation) {
            mutation.addedNodes.forEach(function (node) {
              if (node.tagName === 'text') {
                colorMap[textIndex] = gradeToColor(getNarratorGrade(getNarratorFromName(node.innerHTML)));
                textIndex++;
              }
              if (node.tagName === 'rect') {
                node.setAttribute('fill', colorMap[rectIndex]);
                rectIndex++;
              }
            });
          });
        });
              
        observer.observe(chartDiv, {
          childList: true,
          subtree: true
        });

        google.visualization.events.addListener(chart, 'select', function() {
        var sel = chart.getSelection();
        if (sel.length) {
          console.log(sel);
		  //window.open('http://www.bing.com');
        }
      });
	  
        google.visualization.events.addListener(chart, 'onmouseover', function(e) {
		if(e.name){
			var gradeTooltip = document.querySelector("#gradeTooltip");
			gradeTooltip.style.setProperty('visibility', "visible");
			gradeTooltip.innerHTML = lookupNarrator(getNarratorFromName(e.name))[1] + " : <span style = 'color :" + gradeToColor(getNarratorGrade(getNarratorFromName(e.name))) + ";'>" +getNarratorGrade(getNarratorFromName(e.name))+ "</span>";
		}
		if(!e.name){
			clickDisabled = false;
		}
      });
	  
	  google.visualization.events.addListener(chart, 'onmouseout', function(e) {
	  
		if (e.name){
		  var gradeTooltip = document.querySelector("#gradeTooltip");
		  gradeTooltip.style.setProperty('visibility', "hidden");
		}
		if(!e.name){
			clickDisabled = true;
		}
      });
        chart.draw(data, options);
      }
    </script> 
    <script>
      const el = document.querySelector("#sankey_basic");//tooltip
      el.style.setProperty('--v', "none");
      el.addEventListener("click", (e) => {
        if (el.style.getPropertyValue('--v') != "block" && !clickDisabled){
          el.style.setProperty('--x', Math.min(1300,Math.max(0,e.offsetX -300)) + "px");
          el.style.setProperty('--y', e.offsetY -150 + "px");
          el.style.setProperty('--v', "block");
        }
      }, true);

      el.addEventListener("mousemove", (e) => {
        var Ydiff = Math.max(e.y - el.style.getPropertyValue('--y').split("p")[0], el.style.getPropertyValue('--y').split("p")[0] - e.y);
        if (el.style.getPropertyValue('--v') == "block"){
          if (e.layerX > 590 || e.layerX < 10 || e.offsetY > 250 || e.offsetY < -100) {
            el.style.setProperty('--v', "none");
			clickDisabled = true;
          }
        }
      });
    </script>
  </body>
<footer style="height: 50px; text-align: center;" class="justify-content-center">
	<i class="fa fa-copyright"></i> 2019 Omar Shafie in Doha, Qatar- All Rights Reserved - 
  </footer>
</html>
